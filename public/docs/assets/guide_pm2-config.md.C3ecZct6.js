import{_ as a,o as i,c as n,ag as l}from"./chunks/framework.wGDfT7ie.js";const c=JSON.parse('{"title":"PM2 設定","description":"","frontmatter":{},"headers":[],"relativePath":"guide/pm2-config.md","filePath":"guide/pm2-config.md"}'),e={name:"guide/pm2-config.md"};function t(p,s,h,k,d,r){return i(),n("div",null,[...s[0]||(s[0]=[l(`<h1 id="pm2-設定" tabindex="-1">PM2 設定 <a class="header-anchor" href="#pm2-設定" aria-label="Permalink to &quot;PM2 設定&quot;">​</a></h1><p>CloudPipe 使用 PM2 來管理所有部署的 Node.js 應用程式。</p><h2 id="什麼是-pm2" tabindex="-1">什麼是 PM2？ <a class="header-anchor" href="#什麼是-pm2" aria-label="Permalink to &quot;什麼是 PM2？&quot;">​</a></h2><p><a href="https://pm2.keymetrics.io/" target="_blank" rel="noreferrer">PM2</a> 是 Node.js 的生產環境程序管理器，提供：</p><ul><li>應用程式自動重啟</li><li>負載平衡（cluster mode）</li><li>日誌管理</li><li>監控與效能追蹤</li></ul><h2 id="預設行為" tabindex="-1">預設行為 <a class="header-anchor" href="#預設行為" aria-label="Permalink to &quot;預設行為&quot;">​</a></h2><p>當你部署專案時，CloudPipe 會自動：</p><ol><li>使用專案 ID 作為 PM2 process 名稱</li><li>設定自動重啟（crash 時）</li><li>配置日誌輸出路徑</li><li>注入 <code>PORT</code> 環境變數</li></ol><h2 id="查看-pm2-狀態" tabindex="-1">查看 PM2 狀態 <a class="header-anchor" href="#查看-pm2-狀態" aria-label="Permalink to &quot;查看 PM2 狀態&quot;">​</a></h2><h3 id="透過命令列" tabindex="-1">透過命令列 <a class="header-anchor" href="#透過命令列" aria-label="Permalink to &quot;透過命令列&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看所有 process</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> list</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看特定專案</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> show</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看即時日誌</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看監控面板</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monit</span></span></code></pre></div><h3 id="透過-cloudpipe-dashboard" tabindex="-1">透過 CloudPipe Dashboard <a class="header-anchor" href="#透過-cloudpipe-dashboard" aria-label="Permalink to &quot;透過 CloudPipe Dashboard&quot;">​</a></h3><p>在管理頁面可以：</p><ol><li>查看 process 狀態（運行中 / 停止 / 錯誤）</li><li>查看最近的 logs</li><li>重啟或停止 process</li></ol><h2 id="自訂-pm2-設定" tabindex="-1">自訂 PM2 設定 <a class="header-anchor" href="#自訂-pm2-設定" aria-label="Permalink to &quot;自訂 PM2 設定&quot;">​</a></h2><h3 id="ecosystem-config-js" tabindex="-1">ecosystem.config.js <a class="header-anchor" href="#ecosystem-config-js" aria-label="Permalink to &quot;ecosystem.config.js&quot;">​</a></h3><p>在專案根目錄建立 <code>ecosystem.config.js</code>：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exports</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  apps: [{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;my-app&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    script: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;server.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    instances: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 啟動 2 個 instance</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    exec_mode: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cluster&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// cluster mode</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    env: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      NODE_ENV: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;production&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    max_memory_restart: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;500M&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 記憶體超過 500MB 重啟</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    log_date_format: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;YYYY-MM-DD HH:mm:ss&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>如果專案有 <code>ecosystem.config.js</code>，CloudPipe 會使用它來啟動，而非自動偵測的設定。</p></div><h3 id="常用設定選項" tabindex="-1">常用設定選項 <a class="header-anchor" href="#常用設定選項" aria-label="Permalink to &quot;常用設定選項&quot;">​</a></h3><table tabindex="0"><thead><tr><th>選項</th><th>說明</th><th>範例</th></tr></thead><tbody><tr><td><code>instances</code></td><td>啟動的 instance 數量</td><td><code>2</code> 或 <code>&#39;max&#39;</code></td></tr><tr><td><code>exec_mode</code></td><td>執行模式</td><td><code>&#39;fork&#39;</code> 或 <code>&#39;cluster&#39;</code></td></tr><tr><td><code>max_memory_restart</code></td><td>記憶體上限</td><td><code>&#39;500M&#39;</code></td></tr><tr><td><code>cron_restart</code></td><td>定時重啟</td><td><code>&#39;0 3 * * *&#39;</code> (每天 3 點)</td></tr><tr><td><code>watch</code></td><td>檔案變更時自動重啟</td><td><code>true</code> 或 <code>[&#39;src&#39;]</code></td></tr><tr><td><code>ignore_watch</code></td><td>忽略的檔案</td><td><code>[&#39;node_modules&#39;, &#39;logs&#39;]</code></td></tr></tbody></table><h2 id="cluster-mode" tabindex="-1">Cluster Mode <a class="header-anchor" href="#cluster-mode" aria-label="Permalink to &quot;Cluster Mode&quot;">​</a></h2><p>對於 CPU 密集型應用，可以啟用 cluster mode：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exports</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  apps: [{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;my-api&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    script: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;server.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    instances: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;max&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 使用所有 CPU 核心</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    exec_mode: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cluster&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Cluster mode 需要你的應用程式是 stateless 的（不在記憶體中存放 session）。</p></div><h2 id="日誌管理" tabindex="-1">日誌管理 <a class="header-anchor" href="#日誌管理" aria-label="Permalink to &quot;日誌管理&quot;">​</a></h2><h3 id="日誌路徑" tabindex="-1">日誌路徑 <a class="header-anchor" href="#日誌路徑" aria-label="Permalink to &quot;日誌路徑&quot;">​</a></h3><p>PM2 日誌預設存放在：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>~/.pm2/logs/</span></span>
<span class="line"><span>├── my-app-out.log    # stdout</span></span>
<span class="line"><span>├── my-app-error.log  # stderr</span></span></code></pre></div><h3 id="日誌輪替" tabindex="-1">日誌輪替 <a class="header-anchor" href="#日誌輪替" aria-label="Permalink to &quot;日誌輪替&quot;">​</a></h3><p>安裝 pm2-logrotate 模組：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pm2-logrotate</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 設定保留 7 天</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pm2-logrotate:max_size</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10M</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pm2-logrotate:retain</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7</span></span></code></pre></div><h3 id="透過-api-查看日誌" tabindex="-1">透過 API 查看日誌 <a class="header-anchor" href="#透過-api-查看日誌" aria-label="Permalink to &quot;透過 API 查看日誌&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://epi.isnowfriend.com/api/_admin/deploy/logs/my-app</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Authorization: Bearer </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$TOKEN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span></code></pre></div><h2 id="常用指令" tabindex="-1">常用指令 <a class="header-anchor" href="#常用指令" aria-label="Permalink to &quot;常用指令&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重啟應用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 停止應用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 刪除應用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重載（zero-downtime，僅 cluster mode）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 清除日誌</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> flush</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 儲存目前的 process list</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> save</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 設定開機自動啟動</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> startup</span></span></code></pre></div><h2 id="問題排解" tabindex="-1">問題排解 <a class="header-anchor" href="#問題排解" aria-label="Permalink to &quot;問題排解&quot;">​</a></h2><h3 id="process-一直重啟" tabindex="-1">Process 一直重啟 <a class="header-anchor" href="#process-一直重啟" aria-label="Permalink to &quot;Process 一直重啟&quot;">​</a></h3><p>檢查 logs 找出錯誤原因：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-app</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --lines</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span></span></code></pre></div><p>常見原因：</p><ul><li>Port 衝突</li><li>缺少環境變數</li><li>依賴未安裝</li></ul><h3 id="記憶體持續增長" tabindex="-1">記憶體持續增長 <a class="header-anchor" href="#記憶體持續增長" aria-label="Permalink to &quot;記憶體持續增長&quot;">​</a></h3><p>可能是 memory leak，設定記憶體上限：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  max_memory_restart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;500M&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="查看詳細資訊" tabindex="-1">查看詳細資訊 <a class="header-anchor" href="#查看詳細資訊" aria-label="Permalink to &quot;查看詳細資訊&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> show</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-app</span></span></code></pre></div><p>會顯示：</p><ul><li>重啟次數</li><li>運行時間</li><li>記憶體使用</li><li>CPU 使用</li></ul>`,49)])])}const g=a(e,[["render",t]]);export{c as __pageData,g as default};
