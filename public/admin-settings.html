<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="/newfav.ico">
  <title>管理 - CloudPipe</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    .hidden { display: none !important; }

    /* Tabler Icons */
    .icon { display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; }
    .icon svg { width: 1em; height: 1em; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    .icon-lg svg { width: 2.5rem; height: 2.5rem; }
    .icon-md svg { width: 1.5rem; height: 1.5rem; }
    .icon-sm svg { width: 1.1rem; height: 1.1rem; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* Top Bar */
    .topbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-bottom: 1px solid #252525;
      background: #0a0a0a;
    }
    .topbar a { color: #888; text-decoration: none; font-size: 14px; }
    .topbar a:hover { color: #fff; }
    .topbar .sep { color: #333; }
    .topbar .current { color: #fff; }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #888;
      text-decoration: none;
      margin-right: 8px;
    }
    .back-btn:hover { color: #fff; }
    .topbar-logo { height: 32px; margin-right: 12px; }

    .container { max-width: 900px; margin: 0 auto; padding: 2rem; }

    .page-title {
      font-size: 1.75rem;
      font-weight: 400;
      color: #fff;
      margin-bottom: 2rem;
    }

    /* Section Title */
    .section-title {
      color: #888;
      font-size: 0.85rem;
      font-weight: 400;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Services Section */
    .services-section { margin-bottom: 2.5rem; }
    .services-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
    .service-card {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      padding: 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .service-card:hover { border-color: #4ade80; transform: translateY(-2px); }
    .service-icon { font-size: 2.5rem; flex-shrink: 0; }
    .service-info { flex: 1; min-width: 0; }
    .service-name { font-weight: 500; color: #fff; font-size: 1.1rem; margin-bottom: 2px; }
    .service-desc { font-size: 0.85rem; color: #666; margin-bottom: 4px; }
    .service-stats { font-size: 0.8rem; color: #4ade80; }
    .service-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      flex-shrink: 0;
    }
    .service-status.running { background: #14532d; color: #4ade80; }
    .service-status.failed { background: #5c2626; color: #f87171; }
    .service-status.warning { background: #713f12; color: #fbbf24; }

    /* System Info Section */
    .system-info { margin-bottom: 2.5rem; }
    .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .info-card {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
    }
    .info-label { font-size: 0.8rem; color: #666; margin-bottom: 0.5rem; }
    .info-value { font-size: 1.75rem; font-weight: 500; color: #fff; }
    .info-value.green { color: #4ade80; }

    /* Deployed Section */
    .deployed { margin-bottom: 2rem; }
    .deployed-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .deployed-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #151515;
      border: 1px solid #252525;
      border-radius: 8px;
      padding: 1rem;
    }
    .deployed-item .info { display: flex; align-items: center; gap: 1rem; }
    .deployed-item .icon { font-size: 1.5rem; }
    .deployed-item .name { font-weight: 500; color: #fff; }
    .deployed-item .url { font-size: 0.85rem; color: #4ade80; }
    .deployed-item .status { display: flex; align-items: center; gap: 0.5rem; color: #4ade80; font-size: 0.85rem; }
    .deployed-item .status::before { content: ''; width: 8px; height: 8px; background: #4ade80; border-radius: 50%; }
    .deployed-item .actions { display: flex; gap: 0.5rem; }
    .deployed-item button, .deployed-item a.btn {
      background: #252525;
      border: none;
      color: #888;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      text-decoration: none;
      display: inline-block;
    }
    .deployed-item button:hover, .deployed-item a.btn:hover { background: #333; color: #fff; }
    .deployed-item button.delete:hover { background: #5c2626; color: #f87171; }
    .deployed-item a.btn.admin { background: #1e3a5f; color: #8ab4f8; }
    .deployed-item a.btn.admin:hover { background: #2a4a7f; color: #fff; }
    .empty { text-align: center; color: #555; padding: 2rem; }

    /* Project Detail Modal */
    .project-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .project-modal-content { background: #1a1a1a; border-radius: 12px; width: 100%; max-width: 600px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
    .project-modal-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .project-modal-header h2 { margin: 0; color: #fff; font-size: 1.25rem; }
    .project-modal-body { flex: 1; overflow-y: auto; padding: 20px; }
    .project-modal-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
    .project-modal-actions button, .project-modal-actions a {
      padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.9rem; text-align: center; text-decoration: none; display: block;
    }
    .project-modal-actions .primary { background: #4ade80; color: #000; }
    .project-modal-actions .secondary { background: #252525; color: #fff; }
    .project-modal-actions .danger { background: #5c2626; color: #f87171; }
    .deploy-history { margin-top: 10px; }
    .deploy-history h4 { color: #888; font-size: 0.85rem; margin-bottom: 10px; }
    .deploy-item { background: #252525; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .deploy-item .row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .deploy-item .status { font-weight: 500; }
    .deploy-item .status.success { color: #4ade80; }
    .deploy-item .status.failed { color: #f87171; }
    .deploy-item .time { color: #666; font-size: 0.85rem; }
    .deploy-item .commit { color: #888; font-size: 0.85rem; }
    .deploy-item .error { color: #f87171; font-size: 0.8rem; margin-top: 8px; padding: 8px; background: #2a1515; border-radius: 4px; }

    @media (max-width: 600px) {
      .info-grid { grid-template-columns: 1fr; }
      .services-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="topbar">
    <img src="/Cloud.jpeg" alt="CloudPipe" class="topbar-logo">
    <a href="/_admin" class="back-btn">← 返回</a>
    <span class="sep">/</span>
    <span class="current">管理</span>
  </div>

  <div class="container">
    <h1 class="page-title">管理</h1>

    <!-- 服務管理 -->
    <section class="services-section">
      <h3 class="section-title">服務管理</h3>
      <div class="services-grid" id="servicesGrid">
        <div class="service-card" onclick="window.location.href='/_admin/lurlhub'">
          <div class="service-icon icon icon-lg"><svg viewBox="0 0 24 24"><path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" /><path d="M8 4l0 16" /><path d="M16 4l0 16" /><path d="M4 8l4 0" /><path d="M4 16l4 0" /><path d="M4 12l16 0" /><path d="M16 8l4 0" /><path d="M16 16l4 0" /></svg></div>
          <div class="service-info">
            <div class="service-name">LurlHub <span style="color:#8ab4f8;font-size:0.8em;">:8787</span></div>
            <div class="service-desc">影片/圖片備份服務</div>
            <div class="service-stats" id="lurlStats">載入中...</div>
          </div>
          <div class="service-status running">運行中</div>
        </div>
        <div class="service-card" onclick="window.open('http://localhost:4002/admin', '_blank')">
          <div class="service-icon icon icon-lg"><svg viewBox="0 0 24 24"><path d="M13 3l0 7l6 0l-8 11l0 -7l-6 0l8 -11" /></svg></div>
          <div class="service-info">
            <div class="service-name">Workr <span style="color:#8ab4f8;font-size:0.8em;">:4002</span></div>
            <div class="service-desc">Job Queue 任務處理</div>
            <div class="service-stats" id="workrStats">載入中...</div>
          </div>
          <div class="service-status" id="workrStatus">檢查中</div>
        </div>
      </div>
    </section>

    <!-- 系統資訊 -->
    <section class="system-info">
      <h3 class="section-title">系統資訊</h3>
      <div class="info-grid">
        <div class="info-card">
          <div class="info-label">磁碟使用</div>
          <div class="info-value" id="diskUsage">--</div>
        </div>
        <div class="info-card">
          <div class="info-label">記錄總數</div>
          <div class="info-value green" id="totalRecords">--</div>
        </div>
        <div class="info-card">
          <div class="info-label">運行時間</div>
          <div class="info-value" id="uptime">--</div>
        </div>
      </div>
    </section>

    <!-- 已部署 -->
    <section class="deployed">
      <h3 class="section-title">已部署（上傳）</h3>
      <div class="deployed-list" id="deployedList">
        <div class="empty">載入中...</div>
      </div>
    </section>
  </div>

  <script>
    const authToken = localStorage.getItem('cloudpipe_token');
    let uptimeSeconds = 0;

    // 頁面載入
    window.onload = function() {
      if (!authToken) {
        window.location.href = '/_admin';
        return;
      }
      loadAll();
    };

    async function loadAll() {
      await Promise.all([
        loadLurlStats(),
        loadWorkrStats(),
        loadSystemInfo(),
        loadGitProjects(),
        loadDeployed()
      ]);
    }

    // 載入 Workr 統計
    async function loadWorkrStats() {
      const statsEl = document.getElementById('workrStats');
      const statusEl = document.getElementById('workrStatus');
      try {
        // 透過 cloudpipe proxy 或直接打 workr
        const res = await fetch('/workr/health', { timeout: 5000 });
        if (!res.ok) throw new Error('Not OK');
        const data = await res.json();
        if (data.ok) {
          statsEl.textContent = `${data.queued || 0} 排隊 · ${data.running || 0} 執行中 · ${data.completed || 0} 完成`;
          statusEl.textContent = '運行中';
          statusEl.className = 'service-status running';
        } else {
          throw new Error('Health check failed');
        }
      } catch (e) {
        statsEl.textContent = '無法連線';
        statusEl.textContent = '離線';
        statusEl.className = 'service-status failed';
      }
    }

    // 載入 LurlHub 統計
    async function loadLurlStats() {
      try {
        const res = await fetch('/lurl/api/stats');
        const data = await res.json();
        if (data.totalRecords !== undefined) {
          document.getElementById('lurlStats').textContent =
            `${data.totalRecords} 筆記錄 · ${data.totalVideos || 0} 影片 · ${data.totalImages || 0} 圖片`;
          document.getElementById('totalRecords').textContent = data.totalRecords;
        }
      } catch (e) {
        document.getElementById('lurlStats').textContent = '無法載入';
      }
    }

    // 載入系統資訊
    async function loadSystemInfo() {
      try {
        const res = await fetch('/api/_admin/system', {
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();

        if (data.disk) {
          document.getElementById('diskUsage').textContent = data.disk.used;
        }
        if (data.uptime !== undefined) {
          uptimeSeconds = Math.floor(data.uptime);
          updateUptimeDisplay();
          // 每秒自動增加
          setInterval(() => {
            uptimeSeconds++;
            updateUptimeDisplay();
          }, 1000);
        }
      } catch (e) {
        console.error('載入系統資訊失敗', e);
      }
    }

    function updateUptimeDisplay() {
      document.getElementById('uptime').textContent = formatUptime(uptimeSeconds);
    }

    function formatUptime(seconds) {
      if (seconds < 60) return seconds + ' 秒';
      if (seconds < 3600) return Math.floor(seconds / 60) + ' 分 ' + (seconds % 60) + ' 秒';
      if (seconds < 86400) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        return h + ' 時 ' + m + ' 分';
      }
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400) / 3600);
      return d + ' 天 ' + h + ' 時';
    }

    // 載入已部署（Git 專案 + 上傳的 apps/services）
    async function loadDeployed() {
      try {
        const [servicesRes, projectsRes] = await Promise.all([
          fetch('/api/_admin/services', { headers: { 'authorization': 'Bearer ' + authToken } }),
          fetch('/api/_admin/deploy/projects', { headers: { 'authorization': 'Bearer ' + authToken } })
        ]);
        const data = await servicesRes.json();
        const projectsData = await projectsRes.json();
        const gitProjects = projectsData.projects || [];

        if (data.services.length === 0 && data.apps.length === 0 && gitProjects.length === 0) {
          document.getElementById('deployedList').innerHTML = '<div class="empty">尚無部署</div>';
          return;
        }

        // Icon SVGs
        const rocketIcon = '<span class="icon icon-md"><svg viewBox="0 0 24 24"><path d="M4 13a8 8 0 0 1 7 7a6 6 0 0 0 3 -5a9 9 0 0 0 6 -8a3 3 0 0 0 -3 -3a9 9 0 0 0 -8 6a6 6 0 0 0 -5 3" /><path d="M7 14a6 6 0 0 0 -3 6a6 6 0 0 0 6 -3" /><path d="M15 9m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /></svg></span>';
        const apiIcon = '<span class="icon icon-md"><svg viewBox="0 0 24 24"><path d="M4.876 13.61a4 4 0 1 0 6.124 3.39h6" /><path d="M15.066 20.502a4 4 0 1 0 1.934 -7.502c-.706 0 -1.424 .179 -2 .5l-3 -5.5" /><path d="M16 8a4 4 0 1 0 -8 0c0 1.506 .77 2.818 2 3.5l-3 5.5" /></svg></span>';
        const worldIcon = '<span class="icon icon-md"><svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M3.6 9h16.8" /><path d="M3.6 15h16.8" /><path d="M11.5 3a17 17 0 0 0 0 18" /><path d="M12.5 3a17 17 0 0 1 0 18" /></svg></span>';
        const checkSm = '<span class="icon" style="color:#4ade80;"><svg viewBox="0 0 24 24"><path d="M5 12l5 5l10 -10" /></svg></span>';
        const xSm = '<span class="icon" style="color:#f87171;"><svg viewBox="0 0 24 24"><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg></span>';

        let html = '';
        // Git 專案（含操作按鈕）
        gitProjects.forEach(p => {
          const isSuccess = p.lastDeployStatus === 'success';
          const runningCommit = p.runningCommit || null;
          const lastDeploy = p.lastDeployAt ? new Date(p.lastDeployAt).toLocaleString('zh-TW') : '-';

          let statusHtml = '';
          if (isSuccess && runningCommit) {
            statusHtml = `<span style="color:#4ade80;">${checkSm} ${runningCommit}</span>`;
          } else if (!isSuccess && runningCommit) {
            statusHtml = `<span style="color:#f87171;">${xSm} 失敗</span> <span style="color:#888;font-size:0.85em;">運行中: ${runningCommit}</span>`;
          } else if (!isSuccess) {
            statusHtml = `<span style="color:#f87171;">${xSm} 部署失敗</span>`;
          } else {
            statusHtml = `<span style="color:#4ade80;">運行中</span>`;
          }

          html += `<div class="deployed-item">
            <div class="info">${rocketIcon}<div>
              <div class="name"><a href="https://${p.id}.isnowfriend.com" target="_blank" style="color:#fff;text-decoration:none;">${p.name || p.id}</a>${p.port ? ` <span style="color:#8ab4f8;font-size:0.8em;">:${p.port}</span>` : ''}</div>
              <div class="url">Git 部署 · ${lastDeploy}</div></div></div>
            <div class="status">${statusHtml}</div>
            <div class="actions">
              <button onclick="viewLogs('${p.pm2Name || p.id}')">Log</button>
              <a class="btn" href="https://${p.id}.isnowfriend.com" target="_blank">開啟</a>
              <button onclick="redeployProject('${p.id}')">重新部署</button>
            </div></div>`;
        });
        // API 服務
        data.services.forEach(s => {
          html += `<div class="deployed-item">
            <div class="info">${apiIcon}<div>
              <div class="name"><a href="/${s.name}" target="_blank" style="color:#fff;text-decoration:none;">${s.name}</a></div>
              <div class="url">${s.url}</div></div></div>
            <div class="status">運行中</div>
            <div class="actions">
              <a class="btn admin" href="/${s.name}/admin" target="_blank">後台</a>
              <a class="btn" href="/${s.name}" target="_blank">首頁</a>
              <button class="delete" onclick="deleteItem('service','${s.name}')">刪除</button>
            </div></div>`;
        });
        // 上傳專案
        data.apps.forEach(a => {
          html += `<div class="deployed-item">
            <div class="info">${worldIcon}<div>
              <div class="name"><a href="https://${a.name}.isnowfriend.com" target="_blank" style="color:#fff;text-decoration:none;">${a.name}</a></div>
              <div class="url">${a.url}</div></div></div>
            <div class="status">運行中</div>
            <div class="actions">
              <a class="btn" href="https://${a.name}.isnowfriend.com" target="_blank">開啟</a>
              <button class="delete" onclick="deleteItem('app','${a.name}')">刪除</button>
            </div></div>`;
        });
        document.getElementById('deployedList').innerHTML = html;
      } catch (e) {
        document.getElementById('deployedList').innerHTML = '<div class="empty">載入失敗</div>';
      }
    }

    // 刪除
    async function deleteItem(type, name) {
      if (!confirm('確定刪除 ' + name + '？')) return;
      const endpoint = type === 'service' ? '/api/_admin/service/' + name : '/api/_admin/app/' + name;
      await fetch(endpoint, { method: 'DELETE', headers: { 'authorization': 'Bearer ' + authToken } });
      loadDeployed();
    }

    // 儲存專案資料
    let projectsData = [];

    // 載入 Git 部署專案（加到服務管理區塊）
    async function loadGitProjects() {
      try {
        const res = await fetch('/api/_admin/deploy/projects', {
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();
        projectsData = data.projects || [];

        // 將 Git 專案卡片加到服務管理區塊
        const grid = document.getElementById('servicesGrid');
        projectsData.forEach(p => {
          const isSuccess = p.lastDeployStatus === 'success';
          const runningCommit = p.runningCommit || null;
          const statusClass = isSuccess ? 'running' : (runningCommit ? 'warning' : 'failed');

          // Vercel 風格狀態顯示
          const checkMini = '<span class="icon" style="vertical-align:-1px;"><svg viewBox="0 0 24 24"><path d="M5 12l5 5l10 -10" /></svg></span>';
          const warnMini = '<span class="icon" style="vertical-align:-1px;"><svg viewBox="0 0 24 24"><path d="M12 9v4" /><path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" /><path d="M12 16h.01" /></svg></span>';
          let statusText = '';
          if (isSuccess && runningCommit) {
            statusText = `${checkMini} ${runningCommit}`;
          } else if (!isSuccess && runningCommit) {
            statusText = `${warnMini} ${runningCommit}`;
          } else if (!isSuccess) {
            statusText = '部署失敗';
          } else {
            statusText = '運行中';
          }

          const rocketIconLg = '<span class="icon icon-lg"><svg viewBox="0 0 24 24"><path d="M4 13a8 8 0 0 1 7 7a6 6 0 0 0 3 -5a9 9 0 0 0 6 -8a3 3 0 0 0 -3 -3a9 9 0 0 0 -8 6a6 6 0 0 0 -5 3" /><path d="M7 14a6 6 0 0 0 -3 6a6 6 0 0 0 6 -3" /><path d="M15 9m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /></svg></span>';
          const card = document.createElement('div');
          card.className = 'service-card';
          card.onclick = () => openProjectDetail(p.id);
          card.innerHTML = `
            <div class="service-icon">${rocketIconLg}</div>
            <div class="service-info">
              <div class="service-name">${p.name || p.id}${p.port ? ` <span style="color:#8ab4f8;font-size:0.8em;">:${p.port}</span>` : ''}</div>
              <div class="service-desc">Git 自動部署專案</div>
            </div>
            <div class="service-status ${statusClass}">${statusText}</div>
          `;
          grid.appendChild(card);
        });
      } catch (e) {
        console.error('載入 Git 專案失敗', e);
      }
    }

    // 開啟專案詳情
    async function openProjectDetail(projectId) {
      const project = projectsData.find(p => p.id === projectId);
      if (!project) return;

      // 取得部署記錄
      let deployments = [];
      try {
        const res = await fetch(`/api/_admin/deploy/projects/${projectId}`, {
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();
        deployments = (data.deployments || []).sort((a, b) => new Date(b.startedAt) - new Date(a.startedAt));
      } catch (e) {}

      const repoShort = project.repoUrl ? project.repoUrl.replace('https://github.com/', '').replace('.git', '') : '-';

      const successIcon = '<span class="icon" style="color:#4ade80;vertical-align:-2px;"><svg viewBox="0 0 24 24"><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 12l2 2l4 -4" /></svg></span>';
      const failIcon = '<span class="icon" style="color:#f87171;vertical-align:-2px;"><svg viewBox="0 0 24 24"><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M10 10l4 4m0 -4l-4 4" /></svg></span>';
      let deploysHtml = deployments.length === 0 ? '<p style="color:#666;">無部署記錄</p>' : '';
      deployments.slice(0, 8).forEach(d => {
        const isSuccess = d.status === 'success';
        const time = new Date(d.startedAt).toLocaleString('zh-TW');
        const duration = d.duration ? `${(d.duration/1000).toFixed(1)}s` : '-';
        deploysHtml += `
          <div class="deploy-item">
            <div class="row">
              <span class="status ${d.status}">${isSuccess ? successIcon : failIcon} ${d.status}</span>
              <span class="time">${time} · ${duration}</span>
            </div>
            <div class="commit">${d.commit || '-'} · ${d.triggeredBy || 'unknown'}</div>
            ${d.commitMessage ? `<div class="commit" style="color:#aaa;">${d.commitMessage.substring(0, 60)}</div>` : ''}
            ${d.error ? `<div class="error">${d.error.substring(0, 150)}</div>` : ''}
          </div>
        `;
      });

      const modal = document.createElement('div');
      modal.className = 'project-modal';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      const rocketH = '<span class="icon" style="vertical-align:-2px;"><svg viewBox="0 0 24 24"><path d="M4 13a8 8 0 0 1 7 7a6 6 0 0 0 3 -5a9 9 0 0 0 6 -8a3 3 0 0 0 -3 -3a9 9 0 0 0 -8 6a6 6 0 0 0 -5 3" /><path d="M7 14a6 6 0 0 0 -3 6a6 6 0 0 0 6 -3" /><path d="M15 9m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /></svg></span>';
      const worldH = '<span class="icon" style="vertical-align:-2px;"><svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M3.6 9h16.8" /><path d="M3.6 15h16.8" /><path d="M11.5 3a17 17 0 0 0 0 18" /><path d="M12.5 3a17 17 0 0 1 0 18" /></svg></span>';
      const clipH = '<span class="icon" style="vertical-align:-2px;"><svg viewBox="0 0 24 24"><path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2" /><path d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z" /><path d="M9 12l.01 0" /><path d="M13 12l2 0" /><path d="M9 16l.01 0" /><path d="M13 16l2 0" /></svg></span>';
      const refreshH = '<span class="icon" style="vertical-align:-2px;"><svg viewBox="0 0 24 24"><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" /><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" /></svg></span>';
      const trashH = '<span class="icon" style="vertical-align:-2px;"><svg viewBox="0 0 24 24"><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg></span>';
      modal.innerHTML = `
        <div class="project-modal-content">
          <div class="project-modal-header">
            <h2>${rocketH} ${project.name || project.id} ${project.port ? `<span style="font-size:0.8em;color:#8ab4f8;">:${project.port}</span>` : ''}</h2>
            <button onclick="this.closest('.project-modal').remove()" style="background:#333;border:none;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;">✕</button>
          </div>
          <div class="project-modal-body">
            <div style="color:#888;font-size:0.9rem;margin-bottom:15px;">${repoShort} · ${project.branch || 'main'}</div>
            <div class="project-modal-actions">
              <a href="https://${project.id}.isnowfriend.com" target="_blank" class="primary">${worldH} 開啟網站</a>
              <button onclick="viewLogs('${project.pm2Name || project.id}')" class="secondary">${clipH} 查看 Log</button>
              <button onclick="this.closest('.project-modal').remove(); redeployProject('${project.id}')" class="secondary">${refreshH} 重新部署</button>
              <button onclick="this.closest('.project-modal').remove(); deleteGitProject('${project.id}')" class="danger">${trashH} 刪除專案</button>
            </div>
            <div class="deploy-history">
              <h4>部署記錄（最近 8 筆）</h4>
              ${deploysHtml}
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // 重新部署
    async function redeployProject(id) {
      if (!confirm('確定重新部署 ' + id + '？')) return;
      try {
        await fetch(`/api/_admin/deploy/projects/${id}/deploy`, {
          method: 'POST',
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        alert('已觸發重新部署');
        setTimeout(loadGitProjects, 3000);
      } catch (e) {
        alert('觸發失敗');
      }
    }

    // 刪除 Git 專案
    async function deleteGitProject(id) {
      if (!confirm('確定刪除專案 ' + id + '？')) return;
      try {
        await fetch(`/api/_admin/deploy/projects/${id}`, {
          method: 'DELETE',
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        loadGitProjects();
      } catch (e) {
        alert('刪除失敗');
      }
    }

    // 查看 PM2 Log
    async function viewLogs(pm2Name) {
      try {
        const res = await fetch(`/api/_admin/deploy/logs/${pm2Name}`, {
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();

        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

        const content = document.createElement('div');
        content.style.cssText = 'background:#1a1a1a;border-radius:12px;width:100%;max-width:900px;max-height:80vh;display:flex;flex-direction:column;';

        const logIcon = '<span class="icon" style="vertical-align:-2px;"><svg viewBox="0 0 24 24"><path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2" /><path d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z" /><path d="M9 12l.01 0" /><path d="M13 12l2 0" /><path d="M9 16l.01 0" /><path d="M13 16l2 0" /></svg></span>';
        content.innerHTML = `
          <div style="padding:16px 20px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;color:#fff;">${logIcon} ${pm2Name} Log</h3>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="background:#333;border:none;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;">關閉</button>
          </div>
          <pre style="flex:1;overflow:auto;padding:16px;margin:0;font-size:12px;font-family:monospace;color:#ccc;background:#0d0d0d;white-space:pre-wrap;word-break:break-all;">${data.logs || '無 log'}</pre>
        `;

        modal.appendChild(content);
        document.body.appendChild(modal);
      } catch (e) {
        alert('無法取得 log: ' + e.message);
      }
    }

  </script>
</body>
</html>
